<!DOCTYPE html>
<html>

  <head>
    <title>LodgeFriend Messenger</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/res.css">
    <link rel="stylesheet" href="/css/001.css">
    <link rel="stylesheet" href="/css/animate.css">
    <link rel="stylesheet" href="/css/new.css">
    <link rel="stylesheet" href="/css/font-awesome.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
  </head>
  
  <body onload="loadmsgs();">
    <div class="message-board flex flex-direction-row">
      <!-- Nav Section -->
      <div id="menuDoc" class="log-bar cblack flex-1">
        <ul class="nav flex flex-direction-column">
          <li class="bars">&equiv;</li>
          <li class="onlineUser"><img id ="userimg" src=""></li>
          <a href ="https://facebook.com/lodgefriend"><li style ="color: white;" class="links fa fa-facebook"></li></a>
          <li class="links fa fa-twitter"></li>
          <li class="links fa fa-instagram"></li>
        </ul>
        <div class="brand">LodgeFriend <br><span>&copy; Copyright <br> <?= $dt = date('Y') ?></span></div>
      </div>
      <div id="selector" class="log-bar scroll cblack sblack flex-2">
        <!-- Active users Section -->
        <div class="search loger-head">
          <form>
            <input type="search" placeholder="Search">
            <button class="fa fa-search"></button>
          </form>
        </div>
        <div>
          <ul id="online" class="activeUsers flex flex-direction-column">
          
            
          </ul>
        </div>
      </div>
      <div id="flex-5" class="log-bar chatBox cblack cgrey flex-5">
        <!-- Chats Section -->
          <div class="loger-head cblack cgrey bdcolr">
            <div class="chatWith">
              <span class="barsMain">&equiv;</span>
              <img id="showDet" src="">
              <span id ="showName">Welcome To Lodgefriend Messenger<em class="hide">is typing...</em></span>
            </div>
            <div class="actionBar">
              <i id="sendBack" class="fa fa-arrow-left"></i>
            </div>
          </div>
          <div id="loadChat" class="loger-body maxin">
            <ul id ="messages">
              <li>
                <p>Please Select A Conversation To Begin</p>
              </li>
            </ul>
            
          </div>

        <div class="loger-footer">
          <!--<button class="attach fa fa-paperclip"></button>-->
          <textarea type="text" placeholder="Type your message..." id="m"></textarea>
          <button id ="btn" class="submit fa fa-paper-plane"></button>
        </div>
      </div>
      <!-- User details Section -->
      <form id ="pic_cont">
           <input id ="hider" type ="hidden" />
           <input id ="imageuser" type ="hidden" />
      </form>
      <div id="subSelect" class="log-bar cblack cwhite flex-2 ">
        <div class="loger-head bdcolr">
        
        </div>
        <div class="loger-body no-padding">
          <div class="who">
            <sup class="left online status"></sup>
            <sup class="right fa fa-ellipsis-h"></sup>
            <img id = "anime" class="animated tada infinite" style="animation-duration:2s" src="">
            <span id ="showName1"></span>
          </div>
          <div class="whoDetails">
            <ul>
              <li class=""><span>Nickname:</span><em id ="nicker">Killa Killa</em></li>
              <hr class="whoHr">
              <li class=""><span>Pairup Status</span><em>Needing Connections</em></li>
              <hr class="whoHr">
              <li class=""><span>Gender:</span><em id ="gender"></em></li>
              <hr class="whoHr">
              <li class=""><span>Language:</span><em>English</em></li>
            </ul>
          </div>
        </div>
      </div>
      
    </div>
    <div class="cosmic-loader">
      <i class="fa fa-spinner fa-spin"></i>
    </div>

  <script src="/socket.io/socket.io.js"></script>
  <script src="/js/jquery.js"></script>
  <script type="text/javascript" src="/js/jquery.nicescroll.min.js"></script>
  <script>
 var Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(e){var t="";var n,r,i,s,o,u,a;var f=0;e=Base64._utf8_encode(e);while(f<e.length){n=e.charCodeAt(f++);r=e.charCodeAt(f++);i=e.charCodeAt(f++);s=n>>2;o=(n&3)<<4|r>>4;u=(r&15)<<2|i>>6;a=i&63;if(isNaN(r)){u=a=64}else if(isNaN(i)){a=64}t=t+this._keyStr.charAt(s)+this._keyStr.charAt(o)+this._keyStr.charAt(u)+this._keyStr.charAt(a)}return t},decode:function(e){var t="";var n,r,i;var s,o,u,a;var f=0;e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");while(f<e.length){s=this._keyStr.indexOf(e.charAt(f++));o=this._keyStr.indexOf(e.charAt(f++));u=this._keyStr.indexOf(e.charAt(f++));a=this._keyStr.indexOf(e.charAt(f++));n=s<<2|o>>4;r=(o&15)<<4|u>>2;i=(u&3)<<6|a;t=t+String.fromCharCode(n);if(u!=64){t=t+String.fromCharCode(r)}if(a!=64){t=t+String.fromCharCode(i)}}t=Base64._utf8_decode(t);return t},_utf8_encode:function(e){e=e.replace(/\r\n/g,"\n");var t="";for(var n=0;n<e.length;n++){var r=e.charCodeAt(n);if(r<128){t+=String.fromCharCode(r)}else if(r>127&&r<2048){t+=String.fromCharCode(r>>6|192);t+=String.fromCharCode(r&63|128)}else{t+=String.fromCharCode(r>>12|224);t+=String.fromCharCode(r>>6&63|128);t+=String.fromCharCode(r&63|128)}}return t},_utf8_decode:function(e){var t="";var n=0;var r=c1=c2=0;while(n<e.length){r=e.charCodeAt(n);if(r<128){t+=String.fromCharCode(r);n++}else if(r>191&&r<224){c2=e.charCodeAt(n+1);t+=String.fromCharCode((r&31)<<6|c2&63);n+=2}else{c2=e.charCodeAt(n+1);c3=e.charCodeAt(n+2);t+=String.fromCharCode((r&15)<<12|(c2&63)<<6|c3&63);n+=3}}return t}};

  var socket = io();
  var showUserDetails = $('#showDet');
  var userDetails = $('#subSelect');
  var toggleUsers = $('.barsMain');
  var menuDoc = $('#menuDoc');
  showUserDetails.on('click', openDev);
  function openDev() {
  userDetails.fadeToggle('slow');
}
toggleUsers.click(function(){
  menuDoc.fadeToggle();
});
$(".log-bar").niceScroll({
  cursorcolor: '#b327b3',
  cursoropacitymin: '0',
  cursorborder: '0px',
  cursorborderradius: '7px',
  cursorwidth: '4px',
  cursorminheight: 60,
  horizrailenabled: false,
  zindex: 1090
});
$(".loger-body").niceScroll({
  cursorcolor: '#b327b3',
  cursoropacitymin: '0',
  cursorborder: '0px',
  cursorborderradius: '7px',
  cursorwidth: '4px',
  cursorminheight: 60,
  horizrailenabled: false,
  zindex: 1090
});

$('#sendBack').click(function(){
    $('#flex-5').hide();
  $('#selector').fadeIn();
  //alert('works');
  });
  
var contains = function(needle) {
    // Per spec, the way to identify NaN is that it is not equal to itself
    var findNaN = needle !== needle;
    var indexOf;

    if(!findNaN && typeof Array.prototype.indexOf === 'function') {
        indexOf = Array.prototype.indexOf;
    } else {
        indexOf = function(needle) {
            var i = -1, index = -1;

            for(i = 0; i < this.length; i++) {
                var item = this[i];

                if((findNaN && item !== item) || item === needle) {
                    index = i;
                    break;
                }
            }

            return index;
        };
    }

    return indexOf.call(this, needle) > -1;
};
  function getCookie(cname) {
    var name = cname + "=";
    var ca = document.cookie.split(';');
    for(var i = 0; i < ca.length; i++) {
        var c = ca[i];
        while (c.charAt(0) == ' ') {
            c = c.substring(1);
        }
        if (c.indexOf(name) == 0) {
            return c.substring(name.length, c.length);
        }
    }
    return "";
}

function getQueryVariable(variable)
{
       var query = window.location.search.substring(1);
       var vars = query.split("&");
       for (var i=0;i<vars.length;i++) {
        var space = vars[i].indexOf('=');
        var name = vars[i].substr(0, space);
        var data = vars[i].substr(space+1);

       if(name == variable){return data};
       }
       return(false);
}
 
function bec(abb){
return Base64.decode(abb);
}
function aec(abb){
return atob(abb);
}

function decNow(data){

    try {
    var res = bec(data);
    res = aec(res);
    res = aec(res);
    res = bec(res);
   
    return res;
    } catch (err) {
        return false;
    }

  

}
 

var userenc = getQueryVariable("use");
var recenc = getQueryVariable("req");
if(!decNow(userenc) || !decNow(recenc)){
  
  var user = "";
  var recepient = "";
  var stop ="";
  window.location = "http://lodgefriend.com/msg.php";
}else{
  var user = decNow(userenc);
  var recepient = decNow(recenc);
}


function toTitleCase(str)
{
    return str.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
}
var convoList= [];
//alert(user);
function loadmsgs()
{
  
  $('.cosmic-loader').fadeIn();
  //alert(user)
 
   if(recepient != "" || user !="")
   {
        //Check existence of both users in the db
        var push = user+" "+recepient;
        socket.emit('dbcheck', push);
         /*Check Ends*/
        socket.on('exist', function(data)
        {
       
        if(data!="no")
        {//If the users entering and targeted exists on the db--->
                
                  socket.emit('new-user', user);
                  //alert('localStorage')
                  socket.on('user_dets', function(data){
                    for(i=data.length-1; i>= 0; i--){
                      var image = data[i].image;
                      //alert(image);
                      document.getElementById('userimg').src = 'http://lodgefriend.com/images/users/'+image;//This automatically gives the image its href value
                      document.getElementById('showDet').src = 'http://lodgefriend.com/images/users/'+image;
                  //alert(image);
                  $('#imageuser').val(image);
                    };
                  })
                  
                  //$('#hider').val(recepient);// When you come into this page with the needed url, this stores the recepient of sent messages to be thats indicated in the url.. so without selecting any convo, messages go to the person u entered here with... Till you select another recepient anyway
                 socket.emit('convos', user);
                   socket.on('lastly', function(data){//Recieve the person's last message and send back for the server to process
                      //alert('convos')
                      socket.emit('lastly2', data);
                  });
                  if($(window).width() > 756) 
                  { //Automatically load msges of the url's recepient only if its in desktop mode
                    //alert('users selected')
                   // socket.emit('user selected', recepient); Would work on how to prevent the bug that causes the "user selected" io emit to occure before the "convos" io emit which causes all the html elements housing all the needed info not to load before they are being called, hence "UNDEFINED"
                  }
                  socket.emit('convo begin', recepient);//Create a record of this convo if its a new one
               
            
        }
        else
        {//One or both users dont exist on the db
            window.location = "localhost/pairup/hostel.php";
        };
      });
          /**************************************/
 
      }
    else
    {
      if(stop=="")
      {
        $('#messages').html('No Conversation Selected Yet');
      };
    };
  };

  
  
  socket.on('usernames', function(data){
//alert(data.length); 
    var html ='';
    var pics ='';
    var names ='';
    var genderman ='';
    if(data!=""){
    for(i=data.length-1; i>= 0; i--){
      var username  = data[i].username,
      firstname  = data[i].firstname,
      lastname = data[i].lastname,
      image = data[i].image,
      msg = data[i].message,
      gender = data[i].gender,
      firstname = toTitleCase(firstname);
      lastname = toTitleCase(lastname);
      gender = toTitleCase(gender);
      fullname = firstname+" "+lastname,
      namadd= 'name',
      gend= 'gender',
      nameLastMsg= 'last',
      fullid = username+namadd,
      gendid = username+gend,
      lastmsgSpan = username+nameLastMsg,
      convoList.push(username);
        pics += "<input type ='hidden' id= "+username+" value ="+image+" />";
        names += "<input type ='hidden' id= \""+fullid+"\" value =\""+fullname+"\" />";
        genderman += "<input type ='hidden' id= \""+gendid+"\" value =\""+gender+"\" />";
    html += "<li  id ='list"+username+"' onclick='choose(\""+username+"\")' class = \""+username+"us\"><sup class='online'></sup><img src='http://lodgefriend.com/images/users/"+image+"'><div class='lip'><span class='uname'>" + firstname + " " + lastname + "</span><span id = \""+lastmsgSpan+"\" class='ulast trim'>"+msg+"</span><code id =\""+username+"new\"  class = 'newident' >New</code></div></li><span class='hr'></span>";
    }
  }else{
html+="<p>Hey, You have no conversation started yet.</p>"
  }
    $('#online').append(html);
    $('#pic_cont').append(pics);
    $('#pic_cont').append(names);
    $('#pic_cont').append(genderman);
  
 
  $('.cosmic-loader').fadeOut();
 
  });

  $('#btn').click(function(e){

    e.preventDefault();
    var carrier = $('#hider').val();
  
  
    if (carrier){
      var msg = $('#m').val();
      var send = carrier +' '+ msg;
      socket.emit('private_message', send);
      $('#m').val('');
    }else{
      alert('Please Select A Conversation First Before Sending your message');
      $('#m').val('');
   }
  });
  
  socket.on('specific', function(docs){//Coming from clicking a particular user 

    $('#messages').html('');
 if($(window).width() < 756) {
      $('#selector').hide();
      $('.flex-5').show();

      for(var i=docs.length-1; i >= 0; i--)
      {        
       var time = docs[i].createDate;
        //alert(time);
        time = new Date(time);
        time.setHours(time.getHours() - 1)
        var hour = (time.getHours()<10?'0':'') + time.getHours(),
        min = (time.getMinutes()<10?'0':'') + time.getMinutes();
        
        var ms = '';
        if (docs[i].sender == user){
          var img = $('#imageuser').val();
        ms +="<li><div class='chats'><div class='imgTime2'><img class='chatee' src='http://lodgefriend.com/images/users/"+img+"'><time>"+hour+":"+min+"</time></div><div class='chatText2''> <div class='text'>" + docs[i].msg + "</div></div></div></li>";
      }else{
        //var img = $("#samson").val();
       // var img = document.getElementById(docs[i].sender).value;
        var img = $('#'+docs[i].sender).val();
       
   
        ms +="<li><div class='chats'><div class='imgTime'><img class='chatee' src='http://lodgefriend.com/images/users/"+img+"'><time>"+hour+":"+min+"</time></div><div class='chatText''> <div class='text'>" + docs[i].msg + "</div></div></div></li>";
      }
            
        $('#messages').append(ms);

        var d = $("#loadChat").get(0);//Make sure the scroll bar stays down
        d.scrollTop = d.scrollHeight;

      }
      $('.cosmic-loader').fadeOut();
    }else {

      $('.flex-5').show();
      for(var i=docs.length-1; i >= 0; i--)
      {
      var time = docs[i].createDate;
        //alert(time);
        time = new Date(time);
        
        var hour = (time.getHours()<10?'0':'') + time.getHours(),
        min = (time.getMinutes()<10?'0':'') + time.getMinutes();
        
        var ms = '';
        if (docs[i].sender == user){
          var img = $('#imageuser').val();
        ms +="<li><div class='chats'><div class='imgTime2'><img class='chatee' src='http://lodgefriend.com/images/users/"+img+"'><time>"+hour+":"+min+"</time></div><div class='chatText2''> <div class='text'>" + docs[i].msg + "</div></div></div></li>";
      }else{
        //var img = $("#samson").val();
       // var img = document.getElementById(docs[i].sender).value;
        var img = $('#'+docs[i].sender).val();
       
   
        ms +="<li><div class='chats'><div class='imgTime'><img class='chatee' src='http://lodgefriend.com/images/users/"+img+"'><time>"+hour+":"+min+"</time></div><div class='chatText''> <div class='text'>" + docs[i].msg + "</div></div></div></li>";
      }
            
        $('#messages').append(ms);

        var d = $("#loadChat").get(0);//Make sure the scroll bar stays down
        d.scrollTop = d.scrollHeight;

      }
      $('.cosmic-loader').fadeOut();
    }
     
  var content = $('#messages').html();
  if(!content){//Check if no message has gone on between the two persons
    $('#messages').html('Hey, start a conversation by sending a message');
  }
  });

  socket.on('chat message', function(data){
   
    $('.'+data.nick+'us').addClass('first');
    $('.'+data.target+'us').addClass('first');
    var content = $('#messages').html();
    if(content == "Hey, start a conversation by sending a message"){
      $('#messages').html('');
    }
    var time = new Date();
        var hour = (time.getHours()<10?'0':'') + time.getHours(),
        min = (time.getMinutes()<10?'0':'') + time.getMinutes();
        
       
    var ms ='';
     if (data.nick == user)
     {
        
        var img = $('#imageuser').val();
        ms +="<li><div class='chats'><div class='imgTime2'><img class='chatee' src='http://lodgefriend.com/images/users/"+img+"'><time>"+hour+":"+min+"</time></div><div class='chatText2''> <div class='text'>" + data.msg + "</div></div></div></li>";
     
      }
      else{
$('#'+data.nick+'new').show();
        var index = contains.call(convoList, data.nick);
        if (index == false){
          $('#online').html('');
          socket.emit('convos', user);

        }

        var img = $('#'+data.nick).val();
       $('#'+data.nick+'last').html(data.msg);
        ms +="<li><div class='chats'><div class='imgTime'><img class='chatee' src='http://lodgefriend.com/images/users/"+img+"'><time>"+hour+":"+min+"</time></div><div class='chatText''> <div class='text'>" + data.msg + "</div></div></div></li>";

      }

      $('#'+data.target+'last').html(data.msg);
    
      
    $('#messages').append(ms);
     var d = $("#loadChat").get(0);
     d.scrollTop = d.scrollHeight;
  });
  function choose(targetUser){
    $('.cosmic-loader').fadeIn();
    $('#messages').html('');
    $('#hider').val(targetUser);
    $('.activeUsers li').removeClass('active');
    $('#list'+targetUser).addClass('active');
     //alert($('#hider').val());
     var target = $('#hider').val();

     var image = $('#'+targetUser).val();//There is an input box which stores each of the users details. This helps prevent recurrent calls to the db
     var ident = targetUser+'name';
     var genderid = targetUser+'gender';
     //alert(ident);
     var gender = $('#'+genderid).val();
 
     var fullname = $('#'+ident).val();
     //alert(fullname);
     $('#showName').html(fullname);
     $('#nicker').html(target);
     $('#showName1').html(fullname);
     $('#gender').html(gender);
     document.getElementById('showDet').src = 'http://lodgefriend.com/images/users/'+image;
     document.getElementById('anime').src = 'http://lodgefriend.com/images/users/'+image;
     socket.emit('user selected', target);

  }
  
</script>  
  </body>
</html>
